<?php
/**
 * @var \CoutureSearch\SearchAPI\Block\Adminhtml\System\Config\Sync $block
 */
?>

<div style="margin-bottom: 20px;">
    <?= $block->getButtonHtml() ?>
    <p class="note">
        <span>Click this button to start a full catalogue sync. This process runs in the background.</span>
    </p>
</div>

<div class="sync-status-container">
    <h4>Previous Sync Requests</h4>
    <button id="couture_refresh_button" class="action-secondary">Refresh</button>
    <table id="sync_status_table" class="data-grid">
        <thead>
            <tr>
                <th>Request ID</th>
                <th>Status</th>
                <th>Message</th>
                <th>Created At</th>
                <th>Actions</th> <!-- New Column -->
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="5">Click "Refresh" to see the latest sync status.</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
require(['jquery'], function($){
    // Function to start the sync
    window.check = function() {
        $.ajax({
            url: '<?= $block->escapeUrl($block->getAjaxUrl()) ?>',
            type: 'GET',
            showLoader: true,
            success: function(response) {
                alert(response.message || 'Request sent.');
                refreshStatus();
            },
            error: function(jqXHR) {
                alert('An error occurred. Check the browser console (F12) for details.');
                console.error('AJAX Error:', jqXHR.responseText);
            }
        });
    };

    // Function to cancel a sync
    function cancelSync(syncId) {
        if (!confirm('Are you sure you want to cancel this sync request?')) {
            return;
        }
        $.ajax({
            url: '<?= $block->escapeUrl($block->getCancelUrl()) ?>', // New URL
            type: 'POST',
            data: { id: syncId },
            showLoader: true,
            success: function(response) {
                alert(response.message || 'Cancellation request sent.');
                refreshStatus();
            },
            error: function() {
                alert('An error occurred while trying to cancel the sync.');
            }
        });
    }

    // Function to refresh the status table
    function refreshStatus() {
        $.ajax({
            url: '<?= $block->escapeUrl($block->getRefreshUrl()) ?>',
            type: 'GET',
            showLoader: true,
            success: function(response) {
                var tableBody = $('#sync_status_table tbody');
                tableBody.empty();
                if (response.history && response.history.length) {
                    response.history.forEach(function(item) {
                        var actionsHtml = '';
                        // If the status is Queued or Processing, show a cancel button
                        if (item.status === 'Queued' || item.status === 'Processing') {
                            actionsHtml = '<button class="action-secondary cancel-sync-btn" data-id="' + item.entity_id + '">Cancel</button>';
                        }

                        var row = '<tr>' +
                            '<td>' + item.request_id + '</td>' +
                            '<td>' + item.status + '</td>' +
                            '<td>' + (item.message || '') + '</td>' +
                            '<td>' + item.created_at + '</td>' +
                            '<td>' + actionsHtml + '</td>' + // Add actions cell
                            '</tr>';
                        tableBody.append(row);
                    });
                } else {
                    tableBody.html('<tr><td colspan="5">No sync requests found.</td></tr>');
                }
            }
        });
    }

    // Attach click handler to the refresh button
    $('#couture_refresh_button').on('click', function() {
        refreshStatus();
    });

    // Attach a delegated click handler for the cancel buttons
    $('#sync_status_table').on('click', '.cancel-sync-btn', function() {
        var syncId = $(this).data('id');
        cancelSync(syncId);
    });

    // Initial load of the status
    refreshStatus();
});
</script>
